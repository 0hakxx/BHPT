# 정보수집 및 Nmap 스캔 정리

## Nmap 주의 사항!

| 내용                                                                                          |
|---------------------------------------------------------------------------------------------|
| `nmap -p 22 <IP>` 명령어로 22번 포트만 스캐닝하여도, ICMP,80,443 포트 중 하나라도 Open되어야 포트 스캔이 진행됨 (기본 옵션 동작). |
| 대부분의 호스트는 ICMP,80,443 포트를 사용하지 않는 경우가 많으므로 `-Pn` 옵션을 지정해주는 것이 좋음.                           |
| `--open` 옵션을 추가로 주어, 열린 포트만 결과 출력                                                |
| 전체 포트(`-p-`) 사용하여  Opened/Closed 확인 후 , Opened 포트 대상으로 `-sV`, `-sC` 옵션을 주어 사용 권고            |

---

## 상태(Status) 종류

| 상태      | 설명 |
|-----------|--------------------------------------------------------------------------|
| 열림(Open)    | 포트가 열려 있고, 네트워크 서비스가 실행 중이며 트래픽에 반응함. |
| 닫힘(Closed)  | 포트가 닫혀 있으며, 트래픽에 반응하지 않음. |
| 필터됨(Filtered) | 포트가 방화벽 등으로 인해 트래픽이 차단되어 응답이 없거나 불확실함. 포트 자체는 열려 있을 수 있으나, 네트워크 통신이 불가함. |

---

## Ping 스캔

| 커맨드 | 설명 |
|------------------------|---------------------------------------------------------------|
| `nmap -sn <IP>`        | 지정한 IP에 Ping 스캔을 수행하여 호스트의 생존 여부(응답 유무)만 확인. |
| `nmap -sP <IP>`        | (구버전) Ping 스캔. 현재는 `-sn`으로 통합됨. |
| `nmap -PE <IP>`        | ICMP Echo 요청(Ping)으로 호스트의 생존 여부 확인. |
| `nmap -PS <IP>`        | TCP SYN 패킷을 이용한 Ping 스캔. |
| `nmap -PA <IP>`        | TCP ACK 패킷을 이용한 Ping 스캔. |
| `nmap -PU <IP>`        | UDP 패킷을 이용한 Ping 스캔. |

---

## TCP 스캔

| 커맨드                | 설명 |
|-----------------------|--------------------------------------------------------------------------------|
| `nmap <IP>`           | 기본 1000개 포트에 대해 TCP Connect 스캔(3-way handshake, 로그 남음). |
| `sudo nmap -sS <IP>`  | TCP SYN 스캔(스텔스 스캔, Half-Open, 빠르고 로그가 잘 남지 않음). |
| `nmap -sT <IP>`       | TCP Connect 스캔(권한 없는 사용자가 주로 사용). |
| `nmap -sF <IP>`       | FIN 스캔(방화벽 우회 및 비정상 패킷으로 포트 상태 확인). |
| `nmap -sX <IP>`       | Xmas 스캔(특정 플래그 조합으로 포트 상태 확인). |
| `nmap -sN <IP>`       | Null 스캔(플래그 없는 패킷으로 포트 상태 확인). |
| `nmap -sA <IP>`       | ACK 스캔(방화벽 규칙 확인 및 필터링 탐지). |

---

## UDP 스캔

| 커맨드                | 설명 |
|-----------------------|--------------------------------------------------------------------------|
| `sudo nmap -sU <IP>`  | 1000개의 UDP 포트에 대해 스캔을 수행. |
| `nmap -PU <IP>`       | UDP Ping 스캔(호스트 생존 여부 확인). |

---

## 포트/서비스/OS 탐지

| 커맨드                | 설명 |
|-------------------------|--------------------------------------------------------------------------|
| `nmap -p <포트> <IP>`       | 특정 포트만 스캔. |
| `nmap -p- <IP>`            | 모든 포트(1~65535) 스캔. |
| `nmap -p 8000-9000 <IP>`   | 특정 포트(8000~9000) 스캔. |
| `nmap -F <IP>`             | 빠른 스캔(일반적으로 사용되는 포트만 스캔). |
| `nmap --top-ports 10 <IP>` | 가장 많이 사용하는 10개의 포트만 스캔. |
| `nmap -sV <IP>`            | 서비스 버전 정보 탐지. |
| `nmap -O <IP>`             | 운영체제(OS) 정보 탐지. |
| `nmap -sC <IP>`            | 기본 NSE 스크립트로 취약점/정보 수집. |
| `nc <IP> <Port>`           | 넷캣 + 와이어샤크로 패킷 캡처하여 서비스/OS 확인 기법. |

---

## 결과 저장 및 추가 옵션

| 커맨드                        | 설명 |
|-------------------------------|-------------------------------------------------------------|
| `nmap -oA <파일명> <IP>`               | 결과를 모든 형식(텍스트, XML, grepable)으로 저장. |
| `nmap -oN <파일명> <IP>`               | 결과를 텍스트 파일로 저장. |
| `nmap -oX <파일명.xml> <IP>`           | 결과를 XML 파일로 저장. |
| `nmap --max-rtt-timeout <시간> <IP>`   | 응답 대기 시간 제한. |
| `nmap -e <인터페이스> <IP>`             | 특정 네트워크 인터페이스 지정. |
| `nmap -T<0-5> <IP>`                   | 스캔 속도/스레드 조절 (3~4 추천). |
| `nmap --min-rate 3000 <IP>`           | 초당 패킷 3000개로 스캔. |
| `--open`         						| 열린 포트만 콘솔에 출력. |

---

## 스캔 방식 요약

- **TCP Connect 스캔**: 3-way handshake를 이용해 포트 상태 확인, 로그가 남으며, 느리지만 버전과 같은 상세 정보를 얻을 수 있음.
- **TCP SYN 스캔**: Half-Open 방식, 빠르고 로그가 잘 남지 않으나 버전과 같은 상세 정보를 얻을 수 없음, 권한(sudo) 필요.
- **UDP 스캔**: 비연결성 프로토콜 특성상 신뢰도 낮고 느림, ICMP 응답으로 상태 확인.
- **FIN/Xmas/Null 스캔**: 특수 플래그 조합으로 우회 탐지, 일부 시스템에서만 동작.
- **ACK 스캔**: 방화벽 규칙 확인 목적.
- **Ping 스캔**: 호스트의 생존 여부만 확인, 다양한 프로토콜(ICMP, TCP, UDP)로 가능.

---

## 기타 도구

- **Masscan**
  - 내부망 모의해킹 및 큰 내부망(100만 개 이상 IP, 서브넷 마스크 /16, /8)에 많이 사용되는 빠른 포트 스캐너.
- **Rustscan**
  - Rust 프로그래밍 언어와 Nmap 백엔드 기반의 포트 스캐너, 빠른 속도와 크로스 플랫폼 지원이 장점.
- **Bash/Powershell Oneliner**
  - 침투 후 타겟 호스트의 제한된 환경에서 많이 사용됨.
- 대부분의 경우 Nmap을 많이 사용하며, 큰 외부망/내부망 모의해킹 시 Masscan/Axiom으로 스캔 후 Nmap으로 상세 스캔 수행.

---

## 실무에서는

- **외부망 모의해킹 시 Virtual Hosting 조심**
  - 같은 IP 주소로 중복된 Nmap 스캔 주의.
- **속도와 정확도 = 반비례**
  - 속도가 빠를수록 차단 당할 확률 증가.
- **외부망 모의해킹**
  - 10개 이상 포트 연속 스캔 시 블랙리스트 가능성 높음.
  - 해결책: 분산 스캐닝 – Axiom 사용.
- **내부망 모의해킹**
  - 과도한 TCP SYN Scan 조심 – 방화벽/라우터 과부하 유발 가능.
- **다수 타겟 스캔**
  - Masscan/Axiom -> Nmap 순으로 스캔 권장.
- **모든 포트가 열린 경우**
  - 거짓 양성일 가능성 높음 (방화벽, 호스트 방화벽 등으로 인한 결과).

---

## Nmap NSE (Nmap Scripting Engine)

- **Nmap NSE란?**
  - Nmap의 플러그인 같은 개념으로, 추가 정보 수집과 취약점 진단을 위한 스크립트 제공.
  - 스크립트들은 `/usr/share/nmap/scripts` 경로에 위치.
    
  - 원하는 서비스 관련 스크립트 찾기:  
    `ls -alh /usr/share/nmap/scripts | grep -i <서비스명>`

- **명령어 사용법**
  - `nmap -p <포트> --script <스크립트이름> <IP>`
  - `nmap -p 22 --script ssh-auth-methods <IP>`
  - `nmap -p 22 --script *ssh* <IP>`  
    → NSE 이름 중 ssh가 들어가는 스크립트 모두 실행
  - `nmap -p 22 --script ssh-auth-methods --script-args "ssh.user=root" <IP>`
  - `--script <이름> --script-args "<모듈>.<파라미터>=<값>"`
  
 - **참고**
  - 구글링 및 [nmap.org](https://nmap.org)에서 스크립트 정보 확인
  
  
## 웹 서비스/포트 오픈 예시
- **사용법 예시**
- 브라우저에서 포트(예: 8081)로 접근 시 웹 서비스가 정상적으로 오픈 확인
	- 예시: `http://172.31.253.158:8081` 접속 시 워드프레스 서비스 사용 중 확인
- 워드 프레스 NSE 스크립트 다운로드
	-`cd /usr/share/nmap/scripts`
	- `wget https://github.com/hackertarget/nmap-nse-scripts/blob/master/http-wordpress-themes.nse`
- NSE 스크립트 사용
	-`nmap -p 8081 -sV -Pn --script http-wordpress-themes 172.31.253.158`

---

## Nmap 추가 활용 팁

- `vi /usr/share/nmap/nmap-service-probes`  
  - Nmap이 서비스 버전 탐지 시 참조하는 프로브(probe) 정의 파일.  
  - 직접 편집하거나 커스터마이징하여 새로운 서비스 탐지 가능.

- `ls -al /usr/share/nmap/scripts`  
  - Nmap 스크립트 엔진(NSE)에서 사용하는 다양한 스크립트가 위치한 디렉토리.  
  - 스크립트를 활용해 취약점 탐지, 정보 수집, 자동화된 공격 시나리오 실행 가능.

---
